<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover">

  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">

  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
  <script src="https://d3js.org/topojson.v1.min.js"></script>
  <script src="https://d3js.org/queue.v1.min.js"></script>
  <script src="https://d3js.org/colorbrewer.v1.min.js"></script>

  <title>Historical Migration in the United States</title>
</head>

<body>

  <nav class="navbar navbar-default">
    <div class="container container-fluid">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#defaultNavbar1"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button>
        <a class="navbar-brand" href="https://geo-social.com">Geog 3540</a>
      </div>
      <!-- Collect the nav links, forms, and other content for toggling -->
      <div class="collapse navbar-collapse" id="defaultNavbar1">
        <ul class="nav navbar-nav">

          <li class="dropdown"><a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"><span class="glyphicon glyphicon-menu-hamburger" aria-hidden="true"></span></a>
            <ul class="dropdown-menu" role="menu">
              <li><a href="../shortbio.html">About</a></li>
              <li><a href="../files/loretta_cv.pdf">Resume</a></li>
              <li class="divider"></li>
              <li><a href="chiamaka-nwajiaku@uiowa.edu">Contact</a></li>
            </ul>
          </li>
        </ul>

      </div>
      <!-- /.navbar-collapse -->
    </div>
    <!-- /.container-fluid -->
  </nav>

  <header class="header-section">
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              <h1>Migration in the United States 1800 - 1969 by State</h1>
              <span class="post-meta">Posted on May 29, 2024</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <svg width="960" height="600"></svg>
        <h3 id="using-the-map">Using the Map</h3>
        <ol>
          <li>The map will animate automatically to show Migration in the United States 1800 - 1969.</li>
          <li>At any point, you can hover over the year label (on the right side) to stop the animation.  Moving your cursor horizontally over the year label will automatically update the year that is shown on the choropleth (move left to decrease the year, right to increase the year).</li>
          <li>Hover over a state to see a tooltip providing the state name and the Net flow ratio in that year.</li>
        </ol>
        <script>
          var topoJSONFile = "data/STATES.geojson";
          var projection = d3.geoTransverseMercator().rotate([100,0]);
          var featureCollection = "STATES";
          var idfield = "rootsid";
          var csvFile = "data/netflowratio.csv";
          var attributeAlias = "Net flow Ratio";
          var min = -1, max = 1;
          var beginTime = 1800, endTime = 1960;
          var height = 690;
          var width = 840;
         var manualBreaks = [-1, -0.5, 0.5, 1];

          var svg = d3.select("svg");
          var format = d3.format("");
          var colorScheme = colorbrewer.RdYlBu[5]; // RdYlBu color scheme with 5 classes
          var color = d3.scaleQuantize()
            .domain(manualBreaks)
            .range(colorScheme);

          var x = d3.scaleLinear()
            .domain([0, manualBreaks.length - 1])
            .rangeRound([600, 860]);

          var g = svg.append("g")
            .attr("transform", "translate(0,40)");

          g.selectAll("rect")
            .data(manualBreaks.slice(0, -1)) // Use manual breaks except for the last one
            .enter()
            .append("rect")
            .attr("height", 8)
            .attr("x", function(d, i) { return x(i); })
            .attr("width", x(1) - x(0))
            .attr("fill", function(d) { return color(d); });

            g.append("text")
              .attr("class", "caption")
              .attr("x", x(0))
              .attr("y", -6)
              .attr("fill", "#000")
              .attr("text-anchor", "start")
              .attr("font-weight", "bold")
              .text(attributeAlias);
            
            g.call(d3.axisBottom(x)
              .tickSize(13)
              .tickFormat(function(d, i) { return manualBreaks[i]; })
              .tickValues(d3.range(manualBreaks.length)))
              .select(".domain")
              .remove();

          var div = d3.select("body")
            .append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

          var label = svg.append("text")
            .attr("class", "year label")
            .attr("text-anchor", "end")
            .attr("y", height - 125)
            .attr("x", width + 110 )
            .text(beginTime);

          queue()
            .defer(d3.json, topoJSONFile)
            .defer(d3.csv, csvFile)
            .await(ready);

          function ready(error, featureCollection, csvFile) {
            if (error) throw error;

            var currentYear = beginTime;

            var box = label.node().getBBox();

            var overlay = svg.append("rect")
              .attr("class", "overlay")
              .attr("x", box.x)
              .attr("y", box.y)
              .attr("width", box.width)
              .attr("height", box.height)
              .on("mouseover", enableInteraction);

            svg.transition()
              .duration(60000)
              .ease(d3.easeLinear)
              .tween("year", tweenYear);

            var features = featureCollection.features;
            features.forEach((item) => {
              item.id = +item.properties[idfield];
            });

            var path = d3.geoPath();
            path.projection(projection.fitSize([width, height], featureCollection));

            var STATES = svg.append("g")
              .attr("class", "STATES")
              .selectAll("path")
              .data(features)
              .enter()
              .append("path")
              .attr("d", path)
              .call(style, currentYear);

            function style(STATES, year) {
              newmigration = interpolateData(year);

              var rateById = {};
              var nameById = {};

              newmigration.forEach(function(d) {
                rateById[d.rootsid] = +d.NetflowRatio;
                nameById[d.rootsid] = d.rootsid;
              });

              STATES.style("fill", function(d){
                  return color(rateById[d.id]);
                })
                .on("mouseover", function(d) {
                  div.transition()
                    .duration(200)
                    .style("opacity", .9);
                  div.html(nameById[d.id] + ' in ' + Math.round(currentYear) +': <br><strong>' + rateById[d.id] + '</strong>')
                    .style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("mouseout", function(d) {
                  div.transition()
                    .duration(500)
                    .style("opacity", 0);
                });
            }

            function enableInteraction() {
              var yearScale = d3.scaleLinear()
                .domain([beginTime, endTime])
                .range([box.x + 10, box.x + box.width - 10])
                .clamp(true);

              svg.transition().duration(0);

              overlay
                .on("mouseover", mouseover)
                .on("mouseout", mouseout)
                .on("mousemove", mousemove)
                .on("touchmove", mousemove);

              function mouseover() { label.classed("active", true); }
              function mouseout() { label.classed("active", false); }
              function mousemove() { displayYear(yearScale.invert(d3.mouse(this)[0])); }
            }

            function tweenYear() {
              var yearInterpolator = d3.interpolateNumber(beginTime, endTime);

              return function(t) {
                var interpolatedYear = yearInterpolator(t);
                var decadeYear = Math.round(interpolatedYear / 10) * 10;
                displayYear(decadeYear);
              };
            }

            function displayYear(year) {
              currentYear = year;
              if (year % 10 === 0) {
                STATES.call(style, year);
                label.text(year + "s");
              }
            }

            function interpolateData(year) {
              return csvFile.filter(function(row) {
                return +row['year'] === year;
              });
            }
          }
        </script>
      </div>
    </div>
  </div>

  <footer>
    <div class="container beautiful-jekyll-footer">
      <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
          <ul class="list-inline text-center footer-links">
            <li>
              <p class="copyright text-muted">
                Loretta Nwajiaku &nbsp;&bull;&nbsp; 2024 &nbsp;&bull;&nbsp;
                <a href="http://nwajiaku.github.io">http://nwajiaku.github.io</a>
              </p>
            </li>
            <li>
              <p class="theme-by text-muted">
                Theme by <a href="https://deanattali.com/beautiful-jekyll/">beautiful-jekyll</a>
              </p>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </footer>

</body>
</html>
